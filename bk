(function () {
  const state = {};
  let operationId = 0;
  let currentRow = 6;
  let flagElementsByRow = {};
  const log = document.querySelector("#log");

  const createElement = (html) => {
    return new DOMParser().parseFromString(html, "text/html").body
      .firstElementChild;
  };

  const getPlayerId = () => (Number.isInteger(operationId / 2) ? 1 : 2);

  const getWinner = () => {
    if (currentRow !== 0) return;

    const message = `Player ${getPlayerId()} won!`;
    log.innerHTML = message;
  };

  const createFlags = () => {
    [1, 2, 3, 4, 5, 6]
      .map((row) => {
        return [...Array(row).keys()].map((f) =>
          createElement(`<span class='flag'>${row === 1 ? "🚩" : "🏳"}</span>`)
        );
      })
      .forEach((rowFlags, i) => {
        const id = i + 1;
        const row = createElement(`<div id='row-${id}' class='row'></div>`);
        flagElementsByRow[id] = [];
        document.querySelector("#flags-container").appendChild(row);
        rowFlags.forEach((e) => {
          flagElementsByRow[id].push(e);
          row.appendChild(e);
        });
      });
  };

  const operationIsValid = (numberOfFlags) =>
    flagElementsByRow[currentRow].length >= numberOfFlags;

  const takeFlags = (numberOfFlags) => {
    if (operationIsValid(numberOfFlags)) {
      operationId++;
      flagElementsByRow[currentRow].shift().remove();

      if (numberOfFlags === 2) {
        flagElementsByRow[currentRow].pop().remove();
      }

      if (!flagElementsByRow[currentRow].length) {
        currentRow--;
      }
      log.innerHTML = `Player ${getPlayerId()} took ${numberOfFlags} flags.`;
      getWinner();

      return;
    }

    throw new Error("You can take only one flag");
  };

  const handleTake2Flags = () => {
    takeFlags(2);
  };

  const handleTakeFlag = () => {
    takeFlags(1);
  };

  const startNewGame = () => {
    const teke1btn = document.querySelector("#take-1-button");
    teke1btn.removeEventListener("click", handleTakeFlag);

    const teke2btn = document.querySelector("#take-2-button");
    teke2btn.removeEventListener("click", handleTake2Flags);

    const resetBtn = document.querySelector("#reset-button");
    teke2btn.removeEventListener("click", startNewGame);

    operationId = 0;
    flagElementsByRow = {};
    document.querySelector("#flags-container").innerHTML = "";

    createFlags();

    document.querySelector("#log").innerHTML = "";

    teke1btn.addEventListener("click", handleTakeFlag);

    teke2btn.addEventListener("click", handleTake2Flags);

    resetBtn.addEventListener("click", startNewGame);
  };

  startNewGame();
})();
